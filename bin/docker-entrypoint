#!/bin/bash

# Force output to stdout/stderr immediately
exec > >(cat)
exec 2>&1

echo "=== ENTRYPOINT STARTED ==="
echo "Args: $@"
echo "PWD: $(pwd)"
echo "RAILS_ENV: ${RAILS_ENV}"
echo "PORT: ${PORT}"

# Enable jemalloc if available
if [ -z "${LD_PRELOAD+x}" ]; then
    LD_PRELOAD=$(find /usr/lib -name libjemalloc.so.2 -print -quit 2>/dev/null)
    if [ -n "$LD_PRELOAD" ]; then
        export LD_PRELOAD
        echo "Using jemalloc: $LD_PRELOAD"
    fi
fi

# Prepare database
echo "=== Preparing database ==="
./bin/rails db:prepare || echo "Database prep completed with warnings"
echo "=== Database ready ==="

# Execute the command
echo "=== Starting: $@ ==="
exec "$@"
